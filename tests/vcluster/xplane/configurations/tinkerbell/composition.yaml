apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xplane-tinkerbell
spec:
  compositeTypeRef:
    apiVersion: tinkerbell.sthings.cloud/v1alpha1
    kind: XWorkflow
  mode: Pipeline
  pipeline:
  - functionRef:
      name: function-kcl
    input:
      apiVersion: krm.kcl.dev/v1alpha1
      kind: KCLRun
      metadata:
        name: render-workflow
      spec:
        target: Resources
        params:
          oxr: {}
        source: |
          # Get the XR spec fields from the observed composite resource
          oxr = option("params")?.oxr
          workflowName = oxr?.spec?.workflowName or ""
          workflowNamespace = oxr?.spec?.workflowNamespace or "default"
          templateRef = oxr?.spec?.templateRef or ""
          hardwareRef = oxr?.spec?.hardwareRef or ""
          hardwareMap = oxr?.spec?.hardwareMap or {}
          createWorkflow = oxr?.spec?.createWorkflow or True
          providerConfigRef = oxr?.spec?.providerConfigRef or "in-cluster"

          # Create the Kubernetes Object for Tinkerbell Workflow
          workflow = {
              apiVersion = "kubernetes.crossplane.io/v1alpha2"
              kind = "Object"
              metadata = {
                  name = workflowName
                  annotations = {
                      "crossplane.io/external-name" = workflowName
                  }
              }
              spec = {
                  forProvider = {
                      manifest = {
                          apiVersion = "tinkerbell.org/v1alpha1"
                          kind = "Workflow"
                          metadata = {
                              name = workflowName
                              namespace = workflowNamespace
                          }
                          spec = {
                              templateRef = templateRef
                              hardwareRef = hardwareRef
                              hardwareMap = hardwareMap
                          }
                      }
                  }
                  deletionPolicy = "Delete"
                  managementPolicies = ["*"]
                  providerConfigRef = {
                      name = providerConfigRef
                  }
              }
          }

          # Return the resources to create
          items = [workflow] if createWorkflow else []
    step: render